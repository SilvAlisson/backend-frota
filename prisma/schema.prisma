// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================================
// 1. CONFIGURAÇÕES E RH
// ==========================================================

model ConfiguracaoSistema {
  id                     String   @id @default(cuid())
  diasAntecedenciaAlerta Int      @default(30)
  kmAntecedenciaAlerta   Float    @default(1500)
  updatedAt              DateTime @updatedAt
}

model Treinamento {
  id             String    @id @default(cuid())
  nome           String
  descricao      String?
  dataRealizacao DateTime
  dataVencimento DateTime?
  comprovanteUrl String?

  user   User   @relation(fields: [userId], references: [id])
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Cargo {
  id        String   @id @default(cuid())
  nome      String   @unique 
  descricao String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  colaboradores User[]
  requisitos    TreinamentoObrigatorio[]
}

model TreinamentoObrigatorio {
  id                     String @id @default(cuid())
  nome                   String
  validadeMeses          Int
  diasAntecedenciaAlerta Int    @default(30)

  cargo   Cargo  @relation(fields: [cargoId], references: [id], onDelete: Cascade)
  cargoId String
}

// ==========================================================
// 2. GESTÃO DE USUÁRIOS
// ==========================================================

enum UserRole {
  OPERADOR
  ENCARREGADO
  ADMIN
  RH
  COORDENADOR
}

model User {
  id        String   @id @default(cuid())
  nome      String
  email     String   @unique
  password  String
  matricula String?  @unique
  role      UserRole @default(OPERADOR)
  fotoUrl   String?
  
  cargo   Cargo? @relation(fields: [cargoId], references: [id])
  cargoId String?
  
  cnhNumero    String?
  cnhCategoria String?
  cnhValidade  DateTime? 
  dataAdmissao DateTime?

  loginToken String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  treinamentos             Treinamento[]
  jornadasComoOperador     Jornada[]       @relation("OperadorJornada")
  jornadasComoEncarregado  Jornada[]       @relation("EncarregadoJornada")
  abastecimentos           Abastecimento[]
  ordensServicoRegistradas OrdemServico[]
}

// ==========================================================
// 3. ATIVOS (Veículos e Catálogo)
// ==========================================================

model Veiculo {
  id               String          @id @default(cuid())
  placa            String          @unique
  modelo           String
  ano              Int
  tipoVeiculo      String?         
  tipoCombustivel  TipoCombustivel @default(DIESEL_S10)
  capacidadeTanque Float?
  
  vencimentoCiv    DateTime?
  vencimentoCipp   DateTime?
  
  // NOVO: Status operacional para dashboard (Ex: Ativo, Na Oficina)
  status           StatusVeiculo   @default(ATIVO) 
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jornadas           Jornada[]
  abastecimentos     Abastecimento[]
  ordensServico      OrdemServico[]
  planosManutencao   PlanoManutencao[]
  historicoKm        HistoricoKm[]    // <--- NOVO: Rastreabilidade total de KM
}

model Produto {
  id            String      @id @default(cuid())
  nome          String      @unique 
  tipo          TipoProduto
  unidadeMedida String      @default("Litro")
  
  // SEM ESTOQUE: Funciona apenas como catálogo de itens/serviços
  
  createdAt     DateTime    @default(now())

  itensAbastecimento ItemAbastecimento[]
  itensOrdemServico  ItemOrdemServico[]
}

enum TipoFornecedor {
  POSTO
  OFICINA
  LAVA_JATO
  SEGURADORA
  OUTROS
}

model Fornecedor {
  id        String   @id @default(cuid())
  nome      String   @unique
  cnpj      String?  @unique
  tipo      TipoFornecedor @default(OUTROS)
  
  createdAt DateTime @default(now())

  abastecimentos Abastecimento[]
  ordensServico  OrdemServico[]
}

// ==========================================================
// 4. OPERACIONAL & INTELIGÊNCIA
// ==========================================================

// NOVO: Tabela para inteligência de frota (Média de rodagem, previsão de revisão)
model HistoricoKm {
  id           String   @id @default(cuid())
  km           Float
  dataLeitura  DateTime @default(now())
  
  // Quem gerou esse KM? (Rastreabilidade)
  origem       String   // "JORNADA", "ABASTECIMENTO", "MANUTENCAO", "MANUAL"
  origemId     String?  // ID do registro que gerou
  
  veiculo      Veiculo  @relation(fields: [veiculoId], references: [id])
  veiculoId    String
}

model Jornada { 
  id          String    @id @default(cuid())
  dataInicio  DateTime
  dataFim     DateTime?
  kmInicio    Float
  kmFim       Float?
  
  fotoInicioUrl String?
  fotoFimUrl    String?
  observacoes   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  veiculo       Veiculo @relation(fields: [veiculoId], references: [id])
  veiculoId     String
  
  operador      User    @relation("OperadorJornada", fields: [operadorId], references: [id])
  operadorId    String
  
  encarregado   User    @relation("EncarregadoJornada", fields: [encarregadoId], references: [id])
  encarregadoId String
}

model Abastecimento {
  id                String   @id @default(cuid())
  dataHora          DateTime
  kmOdometro        Float
  custoTotal        Decimal  @db.Decimal(10, 2)
  
  placaCartaoUsado  String?
  observacoes       String?
  justificativa     String?
  fotoNotaFiscalUrl String?
  createdAt         DateTime @default(now())

  veiculo       Veiculo    @relation(fields: [veiculoId], references: [id])
  veiculoId     String
  
  operador      User       @relation(fields: [operadorId], references: [id])
  operadorId    String
  
  fornecedor    Fornecedor @relation(fields: [fornecedorId], references: [id])
  fornecedorId String
  
  itens         ItemAbastecimento[]
}

model ItemAbastecimento {
  id              String   @id @default(cuid())
  quantidade      Float
  valorPorUnidade Decimal  @db.Decimal(10, 2)
  valorTotal      Decimal  @db.Decimal(10, 2)
  createdAt       DateTime @default(now())

  abastecimento   Abastecimento @relation(fields: [abastecimentoId], references: [id])
  abastecimentoId String
  
  produto         Produto       @relation(fields: [produtoId], references: [id])
  produtoId       String
}

// ==========================================================
// 5. MANUTENÇÃO (Com Status)
// ==========================================================

model OrdemServico {
  id                 String         @id @default(cuid())
  data               DateTime
  
  kmAtual            Float?
  veiculoId          String?
  custoTotal         Decimal        @db.Decimal(10, 2)
  
  tipo               TipoManutencao
  
  // NOVO: Controle de status (Aberto/Fechado)
  status             StatusOS       @default(CONCLUIDA) 
  
  observacoes        String?
  fotoComprovanteUrl String?
  createdAt          DateTime       @default(now())

  veiculo        Veiculo?           @relation(fields: [veiculoId], references: [id])
  fornecedor     Fornecedor         @relation(fields: [fornecedorId], references: [id])
  fornecedorId   String
  encarregado    User               @relation(fields: [encarregadoId], references: [id])
  encarregadoId  String
  
  itens          ItemOrdemServico[]
}

model ItemOrdemServico {
  id              String  @id @default(cuid())
  quantidade      Float
  valorPorUnidade Decimal @db.Decimal(10, 2)
  valorTotal      Decimal @db.Decimal(10, 2)
  
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id])
  ordemServicoId  String
  
  produto         Produto      @relation(fields: [produtoId], references: [id])
  produtoId       String 
}

model PlanoManutencao {
  id                    String   @id @default(cuid())
  descricao             String                  
  tipoIntervalo         TipoIntervaloManutencao
  valorIntervalo        Float                 
  
  kmProximaManutencao   Float?
  dataProximaManutencao DateTime?     

  veiculo       Veiculo @relation(fields: [veiculoId], references: [id])
  veiculoId     String
}

// ==========================================================
// ENUMS
// ==========================================================

enum StatusVeiculo {
  ATIVO
  EM_MANUTENCAO
  INATIVO
}

enum StatusOS {
  PENDENTE      // Criada, aguardando aprovação/execução
  EM_ANDAMENTO  // O carro está na oficina
  CONCLUIDA     // Serviço feito e pago
  CANCELADA
}

enum TipoProduto {
  COMBUSTIVEL
  ADITIVO
  LAVAGEM
  PECA
  SERVICO
  OUTRO
}

enum TipoCombustivel {
  DIESEL_S10
  GASOLINA_COMUM
  ETANOL
  GNV
}

enum TipoManutencao {
  PREVENTIVA
  CORRETIVA
  LAVAGEM
}

enum TipoIntervaloManutencao {
  KM
  TEMPO
}