// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================================
// 1. CONFIGURAÇÕES E RH (Novos Módulos)
// ==========================================================

// Configuração global de alertas (Editável pelo Admin/Coordenador)
model ConfiguracaoSistema {
  id                   String   @id @default(cuid())
  diasAntecedenciaAlerta Int    @default(30)   // Ex: 30 dias para vencer CNH/Docs
  kmAntecedenciaAlerta   Float    @default(1500) // Ex: 1500 km para manutenção
  updatedAt            DateTime @updatedAt
}

// Treinamentos e Cursos (Módulo RH)
model Treinamento {
  id             String    @id @default(cuid())
  nome           String    // Ex: "MOPP", "Direção Defensiva"
  descricao      String?
  dataRealizacao DateTime
  dataVencimento DateTime? // Para alertas de renovação
  comprovanteUrl String?   // Foto/PDF do certificado

  user   User   @relation(fields: [userId], references: [id])
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================================
// 2. GESTÃO DE USUÁRIOS E PERFIS
// ==========================================================

enum UserRole {
  OPERADOR
  ENCARREGADO
  ADMIN
  RH           // Novo papel
  COORDENADOR  // Novo papel
}

model User {
  id        String   @id @default(cuid())
  nome      String
  email     String   @unique
  password  String
  matricula String?  @unique // Opcional no cadastro, mas único se existir
  role      UserRole @default(OPERADOR)
  
  // --- DADOS DO RH (CNH & Docs) ---
  cnhNumero    String?
  cnhCategoria String?   // Ex: "AE", "E"
  cnhValidade  DateTime? 
  dataAdmissao DateTime?

  // Acesso Rápido / Recuperação
  loginToken          String?   @unique
  loginTokenExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  treinamentos             Treinamento[]   // Histórico de cursos
  jornadasComoOperador     Jornada[]       @relation("OperadorJornada")
  jornadasComoEncarregado  Jornada[]       @relation("EncarregadoJornada")
  abastecimentos           Abastecimento[]
  ordensServicoRegistradas OrdemServico[]
}

// ==========================================================
// 3. ATIVOS (Veículos e Produtos)
// ==========================================================

model Veiculo {
  id               String          @id @default(cuid())
  placa            String          @unique
  modelo           String
  ano              Int
  tipoVeiculo      String?         // Ex: "Poliguindaste", "Munck"
  tipoCombustivel  TipoCombustivel @default(DIESEL_S10)
  capacidadeTanque Float?
  
  // Controle de Documentação do Veículo
  vencimentoCiv  DateTime?
  vencimentoCipp DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  jornadas         Jornada[]
  abastecimentos   Abastecimento[]
  ordensServico    OrdemServico[]
  planosManutencao PlanoManutencao[]
}

model Produto {
  id            String   @id @default(cuid())
  nome          String   @unique // Ex: "DIESEL S10", "FILTRO DE AR"
  tipo          TipoProduto
  unidadeMedida String   @default("Litro") // Litro, Unidade, Peça, Hora
  createdAt     DateTime @default(now())

  itensAbastecimento ItemAbastecimento[]
  itensOrdemServico  ItemOrdemServico[]
}

model Fornecedor {
  id        String   @id @default(cuid())
  nome      String   @unique
  cnpj      String?  @unique
  createdAt DateTime @default(now())

  abastecimentos Abastecimento[]
  ordensServico  OrdemServico[]
}

// ==========================================================
// 4. OPERACIONAL (Dia a Dia)
// ==========================================================

model Jornada { 
  id          String    @id @default(cuid())
  dataInicio  DateTime
  dataFim     DateTime?
  kmInicio    Float
  kmFim       Float?
  
  fotoInicioUrl String?
  fotoFimUrl    String?
  observacoes   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  veiculo       Veiculo @relation(fields: [veiculoId], references: [id])
  veiculoId     String
  
  operador      User    @relation("OperadorJornada", fields: [operadorId], references: [id])
  operadorId    String
  
  encarregado   User    @relation("EncarregadoJornada", fields: [encarregadoId], references: [id])
  encarregadoId String
}

model Abastecimento {
  id                String   @id @default(cuid())
  dataHora          DateTime
  kmOdometro        Float
  custoTotal        Float
  placaCartaoUsado  String?
  observacoes       String?
  justificativa     String?  // Caso o consumo esteja fora da média
  fotoNotaFiscalUrl String?
  createdAt         DateTime @default(now())

  veiculo      Veiculo    @relation(fields: [veiculoId], references: [id])
  veiculoId    String
  
  operador     User       @relation(fields: [operadorId], references: [id])
  operadorId   String
  
  fornecedor   Fornecedor @relation(fields: [fornecedorId], references: [id])
  fornecedorId String
  
  itens        ItemAbastecimento[]
}

model ItemAbastecimento {
  id              String @id @default(cuid())
  quantidade      Float
  valorPorUnidade Float
  valorTotal      Float
  createdAt       DateTime @default(now())

  abastecimento   Abastecimento @relation(fields: [abastecimentoId], references: [id])
  abastecimentoId String
  
  produto         Produto       @relation(fields: [produtoId], references: [id])
  produtoId       String
}

// ==========================================================
// 5. MANUTENÇÃO E SERVIÇOS
// ==========================================================

model OrdemServico {
  id                 String         @id @default(cuid())
  data               DateTime
  kmAtual            Float
  custoTotal         Float
  tipo               TipoManutencao
  observacoes        String?
  fotoComprovanteUrl String?
  createdAt          DateTime       @default(now())

  veiculo       Veiculo            @relation(fields: [veiculoId], references: [id])
  veiculoId     String
  
  fornecedor    Fornecedor         @relation(fields: [fornecedorId], references: [id])
  fornecedorId  String
  
  encarregado   User               @relation(fields: [encarregadoId], references: [id])
  encarregadoId String
  
  itens         ItemOrdemServico[]
}

model ItemOrdemServico {
  id              String @id @default(cuid())
  quantidade      Float
  valorPorUnidade Float
  valorTotal      Float
  
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id])
  ordemServicoId  String
  
  produto         Produto      @relation(fields: [produtoId], references: [id])
  produtoId       String 
}

model PlanoManutencao {
  id          String                  @id @default(cuid())
  descricao   String                  // Ex: "Troca de Óleo Motor"
  tipoIntervalo TipoIntervaloManutencao
  valorIntervalo Float                // Ex: 10000 (se KM) ou 180 (se dias)
  
  kmProximaManutencao   Float?        // Calculado automaticamente pelo sistema
  dataProximaManutencao DateTime?     // Calculado automaticamente pelo sistema

  veiculo     Veiculo @relation(fields: [veiculoId], references: [id])
  veiculoId   String
}

// ==========================================================
// ENUMS
// ==========================================================

enum TipoProduto {
  COMBUSTIVEL
  ADITIVO
  SERVICO
  OUTRO
}

enum TipoCombustivel {
  DIESEL_S10
  GASOLINA_COMUM
  ETANOL
  GNV
}

enum TipoManutencao {
  PREVENTIVA
  CORRETIVA
  LAVAGEM
}

enum TipoIntervaloManutencao {
  KM
  TEMPO
}