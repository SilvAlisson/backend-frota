// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================================
// 1. CONFIGURA√á√ïES E RH (Novos M√≥dulos)
// ==========================================================

// Configura√ß√£o global de alertas (Edit√°vel pelo Admin/Coordenador)
model ConfiguracaoSistema {
  id                     String   @id @default(cuid())
  diasAntecedenciaAlerta Int      @default(30)   // Ex: 30 dias para vencer CNH/Docs
  kmAntecedenciaAlerta   Float    @default(1500) // Ex: 1500 km para manuten√ß√£o
  updatedAt              DateTime @updatedAt
}

// Treinamentos e Cursos (M√≥dulo RH - Hist√≥rico do Colaborador)
model Treinamento {
  id             String    @id @default(cuid())
  nome           String    // Ex: "MOPP", "Dire√ß√£o Defensiva"
  descricao      String?
  dataRealizacao DateTime
  dataVencimento DateTime? // Para alertas de renova√ß√£o
  comprovanteUrl String?   // Foto/PDF do certificado

  user   User   @relation(fields: [userId], references: [id])
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Cargos e Fun√ß√µes (Ex: Motorista Truck, Operador de Munck)
model Cargo {
  id        String   @id @default(cuid())
  nome      String   @unique 
  descricao String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  colaboradores User[]
  requisitos    TreinamentoObrigatorio[]
}

// Regras de Treinamento por Cargo (O que a vaga exige)
model TreinamentoObrigatorio {
  id                     String @id @default(cuid())
  nome                   String // Ex: "Curso MOPP"
  validadeMeses          Int    // Ex: 24 (2 anos). Se 0, n√£o vence.
  diasAntecedenciaAlerta Int    @default(30) // Alerta personalizado pelo RH para este curso

  cargo   Cargo  @relation(fields: [cargoId], references: [id], onDelete: Cascade)
  cargoId String
}

// ==========================================================
// 2. GEST√ÉO DE USU√ÅRIOS E PERFIS
// ==========================================================

enum UserRole {
  OPERADOR
  ENCARREGADO
  ADMIN
  RH            // Novo papel
  COORDENADOR   // Novo papel
}

model User {
  id        String   @id @default(cuid())
  nome      String
  email     String   @unique
  password  String
  matricula String?  @unique
  role      UserRole @default(OPERADOR)
  
  // Novo campo para Foto de Perfil (Avatar/Crach√°)
  fotoUrl   String?
  
  // --- V√≠nculo de RH ---
  cargo   Cargo? @relation(fields: [cargoId], references: [id])
  cargoId String?
  
  // --- DADOS DO RH (CNH & Docs) ---
  cnhNumero    String?
  cnhCategoria String?   // Ex: "AE", "E"
  cnhValidade  DateTime? 
  dataAdmissao DateTime?

  // Acesso R√°pido / Recupera√ß√£o
  loginToken           String?   @unique
  // REMOVIDO: loginTokenExpiresAt DateTime? <-- Garantia de perman√™ncia

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  treinamentos             Treinamento[]   // Hist√≥rico de cursos realizados
  jornadasComoOperador     Jornada[]       @relation("OperadorJornada")
  jornadasComoEncarregado  Jornada[]       @relation("EncarregadoJornada")
  abastecimentos           Abastecimento[]
  ordensServicoRegistradas OrdemServico[]
}

// ==========================================================
// 3. ATIVOS (Ve√≠culos e Produtos)
// ==========================================================

model Veiculo {
  id               String          @id @default(cuid())
  placa            String          @unique
  modelo           String
  ano              Int
  tipoVeiculo      String?         // Ex: "Poliguindaste", "V√°cuo", "Munck"
  tipoCombustivel  TipoCombustivel @default(DIESEL_S10)
  capacidadeTanque Float?
  
  // Controle de Documenta√ß√£o do Ve√≠culo
  vencimentoCiv  DateTime?
  vencimentoCipp DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  jornadas           Jornada[]
  abastecimentos     Abastecimento[]
  ordensServico      OrdemServico[]
  planosManutencao PlanoManutencao[]
}

model Produto {
  id            String      @id @default(cuid())
  nome          String      @unique // Ex: "DIESEL S10", "FILTRO DE AR"
  tipo          TipoProduto
  unidadeMedida String      @default("Litro") // Litro, Unidade, Pe√ßa, Hora
  createdAt     DateTime    @default(now())

  itensAbastecimento ItemAbastecimento[]
  itensOrdemServico  ItemOrdemServico[]
}

// NOVO ENUM PARA FORNECEDORES
enum TipoFornecedor {
  POSTO
  OFICINA
  LAVA_JATO
  SEGURADORA
  OUTROS
}

model Fornecedor {
  id        String   @id @default(cuid())
  nome      String   @unique
  cnpj      String?  @unique
  
  // NOVO CAMPO DE CLASSIFICA√á√ÉO
  tipo      TipoFornecedor @default(OUTROS)
  
  createdAt DateTime @default(now())

  abastecimentos Abastecimento[]
  ordensServico  OrdemServico[]
}

// ==========================================================
// 4. OPERACIONAL (Dia a Dia)
// ==========================================================

model Jornada { 
  id          String    @id @default(cuid())
  dataInicio  DateTime
  dataFim     DateTime?
  kmInicio    Float
  kmFim       Float?
  
  fotoInicioUrl String?
  fotoFimUrl    String?
  observacoes   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  veiculo       Veiculo @relation(fields: [veiculoId], references: [id])
  veiculoId     String
  
  operador      User    @relation("OperadorJornada", fields: [operadorId], references: [id])
  operadorId    String
  
  encarregado   User    @relation("EncarregadoJornada", fields: [encarregadoId], references: [id])
  encarregadoId String
}

model Abastecimento {
  id                String   @id @default(cuid())
  dataHora          DateTime
  kmOdometro        Float
  
  // üí∞ Decimal para precis√£o monet√°ria
  custoTotal        Decimal  @db.Decimal(10, 2)
  
  placaCartaoUsado  String?
  observacoes       String?
  justificativa     String?  // Caso o consumo esteja fora da m√©dia
  fotoNotaFiscalUrl String?
  createdAt         DateTime @default(now())

  veiculo       Veiculo    @relation(fields: [veiculoId], references: [id])
  veiculoId     String
  
  operador      User       @relation(fields: [operadorId], references: [id])
  operadorId    String
  
  fornecedor    Fornecedor @relation(fields: [fornecedorId], references: [id])
  fornecedorId String
  
  itens         ItemAbastecimento[]
}

model ItemAbastecimento {
  id              String   @id @default(cuid())
  quantidade      Float
  
  // üí∞ Decimal para precis√£o monet√°ria
  valorPorUnidade Decimal  @db.Decimal(10, 2)
  valorTotal      Decimal  @db.Decimal(10, 2)
  
  createdAt       DateTime @default(now())

  abastecimento   Abastecimento @relation(fields: [abastecimentoId], references: [id])
  abastecimentoId String
  
  produto         Produto       @relation(fields: [produtoId], references: [id])
  produtoId       String
}

// ==========================================================
// 5. MANUTEN√á√ÉO E SERVI√áOS
// ==========================================================

model OrdemServico {
  id                 String         @id @default(cuid())
  data               DateTime
  
  // Agora opcionais para permitir manuten√ß√£o sem ve√≠culo (ex: Ca√ßamba)
  kmAtual            Float?
  veiculoId          String?
  
  // üí∞ Decimal para precis√£o monet√°ria
  custoTotal         Decimal        @db.Decimal(10, 2)
  
  tipo               TipoManutencao
  observacoes        String?
  fotoComprovanteUrl String?
  createdAt          DateTime       @default(now())

  // Rela√ß√£o opcional
  veiculo        Veiculo?           @relation(fields: [veiculoId], references: [id])
  
  fornecedor     Fornecedor         @relation(fields: [fornecedorId], references: [id])
  fornecedorId   String
  
  encarregado    User               @relation(fields: [encarregadoId], references: [id])
  encarregadoId String
  
  itens          ItemOrdemServico[]
}

model ItemOrdemServico {
  id              String  @id @default(cuid())
  quantidade      Float
  
  // üí∞ Decimal para precis√£o monet√°ria
  valorPorUnidade Decimal @db.Decimal(10, 2)
  valorTotal      Decimal @db.Decimal(10, 2)
  
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id])
  ordemServicoId  String
  
  produto         Produto      @relation(fields: [produtoId], references: [id])
  produtoId       String 
}

model PlanoManutencao {
  id                    String                  @id @default(cuid())
  descricao             String                  // Ex: "Troca de √ìleo Motor"
  tipoIntervalo TipoIntervaloManutencao
  valorIntervalo Float                 // Ex: 10000 (se KM) ou 180 (se dias)
  
  kmProximaManutencao   Float?        // Calculado automaticamente pelo sistema
  dataProximaManutencao DateTime?     // Calculado automaticamente pelo sistema

  veiculo       Veiculo @relation(fields: [veiculoId], references: [id])
  veiculoId     String
}

// ==========================================================
// ENUMS
// ==========================================================

enum TipoProduto {
  COMBUSTIVEL
  ADITIVO
  LAVAGEM       // Adicionado para controle de lavagens
  PECA          // Adicionado para pe√ßas de manuten√ß√£o
  SERVICO       // Servi√ßos gerais
  OUTRO
}

enum TipoCombustivel {
  DIESEL_S10
  GASOLINA_COMUM
  ETANOL
  GNV
}

enum TipoManutencao {
  PREVENTIVA
  CORRETIVA
  LAVAGEM
}

enum TipoIntervaloManutencao {
  KM
  TEMPO
}