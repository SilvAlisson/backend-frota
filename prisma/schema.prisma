// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================================
// 1. CONFIGURA√á√ïES E RH
// ==========================================================

model ConfiguracaoSistema {
  id                     String   @id @default(cuid())
  diasAntecedenciaAlerta Int      @default(30)
  kmAntecedenciaAlerta   Float    @default(1500)
  updatedAt              DateTime @updatedAt
}

// Tabela normalizada para dados sens√≠veis de RH (1:1 com User)
model ColaboradorProfile {
  id           String    @id @default(cuid())
  cnhNumero    String?
  cnhCategoria String?
  cnhValidade  DateTime?
  dataAdmissao DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique
}

model Treinamento {
  id             String    @id @default(cuid())
  nome           String
  descricao      String?
  dataRealizacao DateTime
  dataVencimento DateTime?
  comprovanteUrl String?

  user   User   @relation(fields: [userId], references: [id])
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Cargo {
  id        String   @id @default(cuid())
  nome      String   @unique 
  descricao String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  colaboradores User[]
  requisitos    TreinamentoObrigatorio[]
}

model TreinamentoObrigatorio {
  id                     String @id @default(cuid())
  nome                   String
  validadeMeses          Int
  diasAntecedenciaAlerta Int    @default(30)

  cargo   Cargo  @relation(fields: [cargoId], references: [id], onDelete: Cascade)
  cargoId String
}

// ==========================================================
// 2. GEST√ÉO DE USU√ÅRIOS
// ==========================================================

enum UserRole {
  OPERADOR
  ENCARREGADO
  ADMIN
  RH
  COORDENADOR
  BOT // Role para automa√ß√µes (Fantasmas)
}

model User {
  id        String   @id @default(cuid())
  nome      String
  email     String   @unique
  password  String
  matricula String?  @unique
  role      UserRole @default(OPERADOR)
  fotoUrl   String?
  
  cargo   Cargo?  @relation(fields: [cargoId], references: [id])
  cargoId String?
  
  // Relacionamento com dados sens√≠veis de RH
  profile ColaboradorProfile?

  loginToken String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  treinamentos             Treinamento[]
  jornadasComoOperador     Jornada[]       @relation("OperadorJornada")
  jornadasComoEncarregado  Jornada[]       @relation("EncarregadoJornada")
  abastecimentos           Abastecimento[]
  ordensServicoRegistradas OrdemServico[]
}

// ==========================================================
// 3. ATIVOS (Ve√≠culos e Cat√°logo)
// ==========================================================

enum TipoVeiculo {
  POLIGUINDASTE
  VACUO
  CARRETA
  UTILITARIO
  CAMINHAO_PIPA
  OUTRO
}

model Veiculo {
  id               String          @id @default(cuid())
  placa            String          @unique
  marca            String?
  modelo           String
  ano              Int
  
  // ‚ö†Ô∏è MUDAN√áA DE SEGURAN√áA:
  // Voltamos para String para n√£o apagar os dados existentes na migra√ß√£o.
  // tipoVeiculo      TipoVeiculo     @default(OUTRO) 
  tipoVeiculo      String?

  tipoCombustivel  TipoCombustivel @default(DIESEL_S10)
  
  capacidadeTanque Float?
  ultimoKm         Float?          @default(0)
  
  vencimentoCiv    DateTime?
  vencimentoCipp   DateTime?
  
  // Status operacional para dashboard (Ex: Ativo, Na Oficina)
  status           StatusVeiculo   @default(ATIVO) 
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jornadas           Jornada[]
  abastecimentos     Abastecimento[]
  ordensServico      OrdemServico[]
  planosManutencao   PlanoManutencao[]
  historicoKm        HistoricoKm[]
}

model Produto {
  id            String      @id @default(cuid())
  nome          String      @unique 
  tipo          TipoProduto
  unidadeMedida String      @default("Litro")
  
  // SEM ESTOQUE: Funciona apenas como cat√°logo de itens/servi√ßos
  createdAt     DateTime    @default(now())

  itensAbastecimento ItemAbastecimento[]
  itensOrdemServico  ItemOrdemServico[]
}

model Fornecedor {
  id        String         @id @default(cuid())
  nome      String         @unique
  cnpj      String?        @unique
  tipo      TipoFornecedor @default(OUTROS)
  
  createdAt DateTime       @default(now())

  abastecimentos Abastecimento[]
  ordensServico  OrdemServico[]
}

// ==========================================================
// 4. OPERACIONAL & INTELIG√äNCIA
// ==========================================================

// Tabela para rastreabilidade e auditoria de KM
model HistoricoKm {
  id           String   @id @default(cuid())
  km           Float
  dataLeitura  DateTime @default(now())
  
  // Quem gerou esse KM? (Rastreabilidade)
  origem       String   // "JORNADA", "ABASTECIMENTO", "MANUTENCAO", "MANUAL", "SISTEMA_AUTO"
  origemId     String?  // ID do registro que gerou
  
  veiculo      Veiculo  @relation(fields: [veiculoId], references: [id])
  veiculoId    String
}

model Jornada { 
  id            String    @id @default(cuid())
  dataInicio    DateTime
  dataFim       DateTime?
  kmInicio      Float
  kmFim         Float?
  
  fotoInicioUrl String?
  fotoFimUrl    String?
  observacoes   String?   // Usado para identificar "Fantasmas" (ex: cont√©m emoji üëª)

  // =========================================================
  // NOVOS CAMPOS PARA O CRON BLINDADO (Dead Letter Queue)
  // =========================================================
  tentativasAutoFechamento Int     @default(0)
  erroAutoFechamento       String? // Guarda o motivo da falha (ex: "Inconsist√™ncia de KM")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  veiculo       Veiculo @relation(fields: [veiculoId], references: [id])
  veiculoId     String
  
  operador      User    @relation("OperadorJornada", fields: [operadorId], references: [id])
  operadorId    String
  
  encarregado   User    @relation("EncarregadoJornada", fields: [encarregadoId], references: [id])
  encarregadoId String

  // Opcional: √çndice para deixar a busca do Cron instant√¢nea
  @@index([dataFim, tentativasAutoFechamento])
}

model Abastecimento {
  id                String   @id @default(cuid())
  dataHora          DateTime
  kmOdometro        Float
  custoTotal        Decimal  @db.Decimal(10, 2)
  
  placaCartaoUsado  String?
  observacoes       String?
  justificativa     String?
  fotoNotaFiscalUrl String?
  createdAt         DateTime @default(now())

  veiculo       Veiculo    @relation(fields: [veiculoId], references: [id])
  veiculoId     String
  
  operador      User       @relation(fields: [operadorId], references: [id])
  operadorId    String
  
  fornecedor    Fornecedor @relation(fields: [fornecedorId], references: [id])
  fornecedorId  String
  
  itens         ItemAbastecimento[]
}

model ItemAbastecimento {
  id              String        @id @default(cuid())
  quantidade      Float
  valorPorUnidade Decimal       @db.Decimal(10, 2)
  valorTotal      Decimal       @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())

  abastecimento   Abastecimento @relation(fields: [abastecimentoId], references: [id])
  abastecimentoId String
  
  produto         Produto       @relation(fields: [produtoId], references: [id])
  produtoId       String
}

// ==========================================================
// 5. MANUTEN√á√ÉO (Com Status)
// ==========================================================

model OrdemServico {
  id                 String         @id @default(cuid())
  data               DateTime
  
  kmAtual            Float?
  veiculoId          String?
  custoTotal         Decimal        @db.Decimal(10, 2)
  
  tipo               TipoManutencao
  status             StatusOS       @default(CONCLUIDA) 
  
  observacoes        String?
  fotoComprovanteUrl String?
  createdAt          DateTime       @default(now())

  veiculo        Veiculo?       @relation(fields: [veiculoId], references: [id])
  fornecedor     Fornecedor     @relation(fields: [fornecedorId], references: [id])
  fornecedorId   String
  encarregado    User           @relation(fields: [encarregadoId], references: [id])
  encarregadoId  String
  
  itens          ItemOrdemServico[]
}

model ItemOrdemServico {
  id              String       @id @default(cuid())
  quantidade      Float
  valorPorUnidade Decimal      @db.Decimal(10, 2)
  valorTotal      Decimal      @db.Decimal(10, 2)
  
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id])
  ordemServicoId  String
  
  produto         Produto      @relation(fields: [produtoId], references: [id])
  produtoId       String 
}

model PlanoManutencao {
  id                    String                  @id @default(cuid())
  descricao             String                  
  tipoIntervalo         TipoIntervaloManutencao
  valorIntervalo        Float                 
  
  kmProximaManutencao   Float?
  dataProximaManutencao DateTime?     

  veiculo       Veiculo @relation(fields: [veiculoId], references: [id])
  veiculoId     String
}

// ==========================================================
// ENUMS
// ==========================================================

enum StatusVeiculo {
  ATIVO
  EM_MANUTENCAO
  INATIVO
}

enum StatusOS {
  PENDENTE      
  EM_ANDAMENTO  
  CONCLUIDA     
  CANCELADA
}

enum TipoProduto {
  COMBUSTIVEL
  ADITIVO
  LAVAGEM
  PECA
  SERVICO
  OUTRO
}

enum TipoCombustivel {
  DIESEL_S10
  GASOLINA_COMUM
  ETANOL
  GNV
}

enum TipoFornecedor {
  POSTO
  OFICINA
  LAVA_JATO
  SEGURADORA
  OUTROS
}

enum TipoManutencao {
  PREVENTIVA
  CORRETIVA
  LAVAGEM
}

enum TipoIntervaloManutencao {
  KM
  TEMPO
}