// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================================
// 1. CONFIGURA칂칏ES E RH (Novos M칩dulos)
// ==========================================================

// Configura칞칚o global de alertas (Edit치vel pelo Admin/Coordenador)
model ConfiguracaoSistema {
  id                     String   @id @default(cuid())
  diasAntecedenciaAlerta Int      @default(30)   // Ex: 30 dias para vencer CNH/Docs
  kmAntecedenciaAlerta   Float    @default(1500) // Ex: 1500 km para manuten칞칚o
  updatedAt              DateTime @updatedAt
}

// Treinamentos e Cursos (M칩dulo RH - Hist칩rico do Colaborador)
model Treinamento {
  id             String    @id @default(cuid())
  nome           String    // Ex: "MOPP", "Dire칞칚o Defensiva"
  descricao      String?
  dataRealizacao DateTime
  dataVencimento DateTime? // Para alertas de renova칞칚o
  comprovanteUrl String?   // Foto/PDF do certificado

  user   User   @relation(fields: [userId], references: [id])
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Cargos e Fun칞칫es (Ex: Motorista Truck, Operador de Munck)
model Cargo {
  id        String   @id @default(cuid())
  nome      String   @unique 
  descricao String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  colaboradores User[]
  requisitos    TreinamentoObrigatorio[]
}

// Regras de Treinamento por Cargo (O que a vaga exige)
model TreinamentoObrigatorio {
  id                     String @id @default(cuid())
  nome                   String // Ex: "Curso MOPP"
  validadeMeses          Int    // Ex: 24 (2 anos). Se 0, n칚o vence.
  diasAntecedenciaAlerta Int    @default(30) // Alerta personalizado pelo RH para este curso

  cargo   Cargo  @relation(fields: [cargoId], references: [id], onDelete: Cascade)
  cargoId String
}

// ==========================================================
// 2. GEST츾O DE USU츼RIOS E PERFIS
// ==========================================================

enum UserRole {
  OPERADOR
  ENCARREGADO
  ADMIN
  RH           // Novo papel
  COORDENADOR  // Novo papel
}

model User {
  id        String   @id @default(cuid())
  nome      String
  email     String   @unique
  password  String
  matricula String?  @unique
  role      UserRole @default(OPERADOR)
  
  // Novo campo para Foto de Perfil (Avatar/Crach치)
  fotoUrl   String?
  
  // --- V칤nculo de RH ---
  cargo   Cargo? @relation(fields: [cargoId], references: [id])
  cargoId String?
  
  // --- DADOS DO RH (CNH & Docs) ---
  cnhNumero    String?
  cnhCategoria String?   // Ex: "AE", "E"
  cnhValidade  DateTime? 
  dataAdmissao DateTime?

  // Acesso R치pido / Recupera칞칚o
  loginToken          String?   @unique
  loginTokenExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  treinamentos             Treinamento[]   // Hist칩rico de cursos realizados
  jornadasComoOperador     Jornada[]       @relation("OperadorJornada")
  jornadasComoEncarregado  Jornada[]       @relation("EncarregadoJornada")
  abastecimentos           Abastecimento[]
  ordensServicoRegistradas OrdemServico[]
}

// ==========================================================
// 3. ATIVOS (Ve칤culos e Produtos)
// ==========================================================

model Veiculo {
  id               String          @id @default(cuid())
  placa            String          @unique
  modelo           String
  ano              Int
  tipoVeiculo      String?         // Ex: "Poliguindaste", "V치cuo", "Munck"
  tipoCombustivel  TipoCombustivel @default(DIESEL_S10)
  capacidadeTanque Float?
  
  // Controle de Documenta칞칚o do Ve칤culo
  vencimentoCiv  DateTime?
  vencimentoCipp DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  jornadas         Jornada[]
  abastecimentos   Abastecimento[]
  ordensServico    OrdemServico[]
  planosManutencao PlanoManutencao[]
}

model Produto {
  id            String      @id @default(cuid())
  nome          String      @unique // Ex: "DIESEL S10", "FILTRO DE AR"
  tipo          TipoProduto
  unidadeMedida String      @default("Litro") // Litro, Unidade, Pe칞a, Hora
  createdAt     DateTime    @default(now())

  itensAbastecimento ItemAbastecimento[]
  itensOrdemServico  ItemOrdemServico[]
}

model Fornecedor {
  id        String   @id @default(cuid())
  nome      String   @unique
  cnpj      String?  @unique
  createdAt DateTime @default(now())

  abastecimentos Abastecimento[]
  ordensServico  OrdemServico[]
}

// ==========================================================
// 4. OPERACIONAL (Dia a Dia)
// ==========================================================

model Jornada { 
  id          String    @id @default(cuid())
  dataInicio  DateTime
  dataFim     DateTime?
  kmInicio    Float
  kmFim       Float?
  
  fotoInicioUrl String?
  fotoFimUrl    String?
  observacoes   String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  veiculo       Veiculo @relation(fields: [veiculoId], references: [id])
  veiculoId     String
  
  operador      User    @relation("OperadorJornada", fields: [operadorId], references: [id])
  operadorId    String
  
  encarregado   User    @relation("EncarregadoJornada", fields: [encarregadoId], references: [id])
  encarregadoId String
}

model Abastecimento {
  id                String   @id @default(cuid())
  dataHora          DateTime
  kmOdometro        Float
  
  // 游눯 Decimal para precis칚o monet치ria
  custoTotal        Decimal  @db.Decimal(10, 2)
  
  placaCartaoUsado  String?
  observacoes       String?
  justificativa     String?  // Caso o consumo esteja fora da m칠dia
  fotoNotaFiscalUrl String?
  createdAt         DateTime @default(now())

  veiculo      Veiculo    @relation(fields: [veiculoId], references: [id])
  veiculoId    String
  
  operador     User       @relation(fields: [operadorId], references: [id])
  operadorId   String
  
  fornecedor   Fornecedor @relation(fields: [fornecedorId], references: [id])
  fornecedorId String
  
  itens        ItemAbastecimento[]
}

model ItemAbastecimento {
  id              String   @id @default(cuid())
  quantidade      Float
  
  // 游눯 Decimal para precis칚o monet치ria
  valorPorUnidade Decimal  @db.Decimal(10, 2)
  valorTotal      Decimal  @db.Decimal(10, 2)
  
  createdAt       DateTime @default(now())

  abastecimento   Abastecimento @relation(fields: [abastecimentoId], references: [id])
  abastecimentoId String
  
  produto         Produto       @relation(fields: [produtoId], references: [id])
  produtoId       String
}

// ==========================================================
// 5. MANUTEN칂츾O E SERVI칂OS
// ==========================================================

model OrdemServico {
  id                 String         @id @default(cuid())
  data               DateTime
  
  // Agora opcionais para permitir manuten칞칚o sem ve칤culo (ex: Ca칞amba)
  kmAtual            Float?
  veiculoId          String?
  
  // 游눯 Decimal para precis칚o monet치ria
  custoTotal         Decimal        @db.Decimal(10, 2)
  
  tipo               TipoManutencao
  observacoes        String?
  fotoComprovanteUrl String?
  createdAt          DateTime       @default(now())

  // Rela칞칚o opcional
  veiculo       Veiculo?           @relation(fields: [veiculoId], references: [id])
  
  fornecedor    Fornecedor         @relation(fields: [fornecedorId], references: [id])
  fornecedorId  String
  
  encarregado   User               @relation(fields: [encarregadoId], references: [id])
  encarregadoId String
  
  itens         ItemOrdemServico[]
}

model ItemOrdemServico {
  id              String  @id @default(cuid())
  quantidade      Float
  
  // 游눯 Decimal para precis칚o monet치ria
  valorPorUnidade Decimal @db.Decimal(10, 2)
  valorTotal      Decimal @db.Decimal(10, 2)
  
  ordemServico    OrdemServico @relation(fields: [ordemServicoId], references: [id])
  ordemServicoId  String
  
  produto         Produto      @relation(fields: [produtoId], references: [id])
  produtoId       String 
}

model PlanoManutencao {
  id          String                  @id @default(cuid())
  descricao   String                  // Ex: "Troca de 칍leo Motor"
  tipoIntervalo TipoIntervaloManutencao
  valorIntervalo Float                // Ex: 10000 (se KM) ou 180 (se dias)
  
  kmProximaManutencao   Float?        // Calculado automaticamente pelo sistema
  dataProximaManutencao DateTime?     // Calculado automaticamente pelo sistema

  veiculo     Veiculo @relation(fields: [veiculoId], references: [id])
  veiculoId   String
}

// ==========================================================
// ENUMS
// ==========================================================

enum TipoProduto {
  COMBUSTIVEL
  ADITIVO
  LAVAGEM      // Adicionado para controle de lavagens
  PECA         // Adicionado para pe칞as de manuten칞칚o
  SERVICO      // Servi칞os gerais
  OUTRO
}

enum TipoCombustivel {
  DIESEL_S10
  GASOLINA_COMUM
  ETANOL
  GNV
}

enum TipoManutencao {
  PREVENTIVA
  CORRETIVA
  LAVAGEM
}

enum TipoIntervaloManutencao {
  KM
  TEMPO
}